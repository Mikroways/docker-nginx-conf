{{$serverPort := getv "/self/service/metadata/nginx/conf/server_port"}}
{{$serverName := getv "/self/service/metadata/nginx/conf/server_name"}}
{{$serverRoot := getv "/self/service/metadata/nginx/conf/server_root"}}
{{$index := getv "/self/service/metadata/nginx/conf/index"}}
{{$upstreamName := getv "/self/service/metadata/nginx/conf/upstream"}}
upstream {{$upstreamName}} {
   server 127.0.0.1:{{getv "/self/service/metadata/nginx/conf/upstream_port"}};
}

server {
    listen {{$serverPort}};
    server_name {{$serverName}};

    root {{$serverRoot}};

    {{if exists "/self/service/metadata/nginx/conf/custom_location/*/value"}}
        location {{getv "/self/service/metadata/nginx/conf/custom_location/*/value"}} {

        }
    {{end}}
    
    {{range gets "/self/service/metadata/nginx/conf/custom_location/*"}}
        location {{.}} {
            index index.php
        }
    {{end}}
    
    
    location /index.php {
        proxy_pass http://{{$upstreamName}};
    }
}
