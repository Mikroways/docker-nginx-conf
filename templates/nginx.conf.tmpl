{{$nginx := getenv "NGINX"}}
{{$upstream_options := printf "/services/%s/metadata/nginx-conf/upstream_location_options" $nginx}}{{if exists $upstream_options}}
upstream app {
  server {{$server := printf "/services/%s/metadata/nginx-conf/server" $nginx}}{{if exists $server}}{{getv $server}}{{else}}127.0.0.1{{end}}:{{
}
{{end}}
server {
  server_name _;
  root {{$root := printf "/services/%s/metadata/nginx-conf/root" $nginx}}{{if exists $root}}{{getv $root}}{{else}}/usr/share/nginx/html{{end}};

  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log;

  {{$server_custom_opt := printf "/services/%s/metadata/nginx-conf/server_custom_options" $nginx}}{{if exists $server_custom_opt}}{{getv $serve

  location / {
    {{$root_location_opt := printf "/services/%s/metadata/nginx-conf/root_location_options" $nginx}}{{if exists $root_location_opt}}{{getv $roo
  }

  {{$fpm_options := printf "/services/%s/metadata/nginx-conf/fpm_options" $nginx}}{{if exists $fpm_options}}
  location ~ [^/]\.php(/|$) {
    fastcgi_split_path_info ^(.+?\.php)(/.*)$;
    if (!-f $document_root$fastcgi_script_name) {
      return 404;
    }
    include fastcgi_params;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param SERVER_PORT $http_x_forwarded_port;
    fastcgi_pass {{$server := printf "/services/%s/metadata/nginx-conf/server" $nginx}}{{if exists $server}}{{getv $server}}{{else}}127.0.0.1{{
    {{$fpm_option_options := printf "/services/%s/metadata/nginx-conf/fpm_options/options" $nginx}}{{getv $fpm_option_options}}
  {{end}}

{{$upstream_options := printf "/services/%s/metadata/nginx-conf/upstream_location_options" $nginx}}{{if exists $upstream_options}}             
  location @app {                                                                                                                              
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;                                                                               
    proxy_set_header Host $http_host;                                                                                                          
    proxy_redirect off;                                                                                                                        
    proxy_pass http://app;                                                                                                                     
    {{getv $upstream_options}}                                                                                                                 
  }                                                                                                                                            
{{end}}                                                                                                                                        
                                                                                                                                  
  location {{$static_files_regexp_location := printf "/services/%s/metadata/nginx-conf/static_files_regexp_location" $nginx}}{{if exists $stati
    try_files $uri{{if exists "/services/nginx/metadata/nginx-conf/upstream_location_options"}} @app{{end}};                                   
    access_log off;                                                                                                                            
    log_not_found off;                                                                                                                         
    expires max;                                                                                                                               
    break ;                                                                                                                                    
  }                                                                                                                                            
}
