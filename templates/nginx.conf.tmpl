{{range $upstream := lsdir "/self/service/metadata/nginx/upstreams"}}
upstream {{$server := printf "/self/service/metadata/nginx/upstreams/%s/upstream_name" $upstream}}{{getv $server}} {
    server {{$upstream_name := printf "/self/service/metadata/nginx/upstreams/%s/upstream" $upstream}}{{getv $upstream_name}};
}
{{end}}


{{range $servers := lsdir "/self/service/metadata/nginx/servers"}}
server {  #empieza un server
  {{range $key_conf := ls $conf_server}}
    {{$value_conf := printf "/self/service/metadata/nginx/servers/%s/custom_conf/%s" $servers $key_conf}}{{$key_conf}}:{{getv $value_conf}} 
  {{end}}

  {{$custom_server := printf "/self/service/metadata/nginx/servers/%s/custom_location" $servers}}{{range $dir := lsdir $custom_server}}{{$custom_dir := printf "/self/service/metadata/nginx/servers/%s/custom_location/%s" $servers $dir}}{{range $options_dir := lsdir $custom_dir}}
  {{$value_dir := printf "/self/service/metadata/nginx/servers/%s/custom_location/%s/value" $servers $dir}}
  location {{getv $value_dir}}
  {
    {{$dir_option := printf "/self/service/metadata/nginx/servers/%s/custom_location/%s/options" $servers $dir}}{{range $value_dir := ls $dir_option}}{{$fin_option := printf "/self/service/metadata/nginx/servers/%s/custom_location/%s/options/%s" $servers $dir $value_dir}}{{getv $fin_option}}
    {{end}}
  }{{end}}{{end}}

} #termina un serveri


{{end}}
