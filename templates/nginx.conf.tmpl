{{$serverPort := getv "/self/service/metadata/nginx/conf/server_port"}}
{{$serverName := getv "/self/service/metadata/nginx/conf/server_name"}}
{{$serverRoot := getv "/self/service/metadata/nginx/conf/server_root"}}
{{$index := getv "/self/service/metadata/nginx/conf/index"}}
{{$upstreamName := getv "/self/service/metadata/nginx/conf/upstream"}}
upstream {{$upstreamName}} {
   server 127.0.0.1:{{getv "/self/service/metadata/nginx/conf/upstream_port"}};
}

server {
    listen {{$serverPort}};
    server_name {{$serverName}};

    root {{$serverRoot}};

    {{ range $dir := lsdir "/self/service/metadata/nginx/conf/custom_location" }}
        {{ $custom_dir := printf "/self/service/metadata/nginx/conf/custom_location/%s" $dir}}{{ range $options_dir := lsdir $custom_dir }}
       
            {{$value_dir := printf "/self/service/metadata/nginx/conf/custom_location/%s/value" $dir}}{{if exists $value_dir}}
            location {{getv $value_dir}}
            {
                index index.php; #Es el value;
            }
            {{end}}
            
            {{$option_dir := printf "/self/service/metadata/nginx/conf/custom_location/%s/options" $dir}}{{if exists $option_dir}}
                {{range $options_val_dir := lsdir $option_dir }}
                    {{$val_option := printf "/self/service/metadata/nginx/conf/custom_location/%s/options/%s" $dir $options_val_dir}}
                    {{getv $val_option}};
                {{end}}
            {{end}}
            
        {{end}}
    {{end}}

    location /index.php {
        proxy_pass http://{{$upstreamName}};
    }
}
