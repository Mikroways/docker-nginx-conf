{{$serverPort := getv "/self/service/metadata/nginx/conf/server_port"}}
{{$serverName := getv "/self/service/metadata/nginx/conf/server_name"}}
{{$serverRoot := getv "/self/service/metadata/nginx/conf/server_root"}}
{{$index := getv "/self/service/metadata/nginx/conf/index"}}
{{$upstreamName := getv "/self/service/metadata/nginx/conf/upstream"}}
upstream {{$upstreamName}} {
   server 127.0.0.1:{{getv "/self/service/metadata/nginx/conf/upstream_port"}};
}

server {
    listen {{$serverPort}};
    server_name {{$serverName}};
    root {{$serverRoot}};

    {{ range $dir := lsdir "/self/service/metadata/nginx/conf/custom_location" }}{{ $custom_dir := printf "/self/service/metadata/nginx/conf/custom_location/%s" $dir}}{{ range $options_dir := lsdir $custom_dir }}
       {{$value_dir := printf "/self/service/metadata/nginx/conf/custom_location/%s/value" $dir}}
  location {{getv $value_dir}}
  {
    {{$directorio := printf "/self/service/metadata/nginx/conf/custom_location/%s/options" $dir}}{{range $valor := ls $directorio }}{{$final := printf "/self/service/metadata/nginx/conf/custom_location/%s/options/%s" $dir $valor}}{{getv $final}};
    {{end}}
  }{{end}}{{end}}
}
